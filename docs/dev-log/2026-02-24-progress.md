# 개발 일지 — 2026-02-24

---

## 2026-02-27 완료된 작업 (2차)

### A. 로딩 스피너 GIF 통합 — MomoLoading 위젯

**목표**: 전체 페이지 레벨 `CircularProgressIndicator`를 캐릭터 GIF(`loading_spinner.gif`)로 교체

**신규 파일:**
- `lib/core/widgets/momo_loading.dart` — `MomoLoading(size: 64)` 공통 위젯

**적용 파일 (10개):**
- `lib/app/routes/app_router.dart` (스플래시)
- `lib/features/profile/presentation/pages/profile_page.dart`
- `lib/features/chat/presentation/pages/chat_list_page.dart`
- `lib/features/chat/presentation/pages/chat_room_page.dart`
- `lib/features/matching/presentation/pages/matching_page.dart`
- `lib/features/matching/presentation/pages/compatibility_preview_page.dart` (2곳)
- `lib/features/gwansang/presentation/pages/gwansang_photo_page.dart`
- `lib/features/saju/presentation/pages/saju_analysis_page.dart`

**에셋 등록:** `pubspec.yaml`에 `loading_spinner.gif`, `glod_rabbit_thrash.gif` 추가

### B. 온보딩 화면 전환 시 검은 화면 깜박임 수정

**문제**: 온보딩 인트로 슬라이드 → 이름 입력 폼 전환 시 검은 프레임 1장 노출
**원인**: `FadeTransition`이 내부적으로 `saveLayer`를 사용하는데, `OnboardingFormPage`가 `Scaffold`를 포함하여 별도 Material Surface를 생성. 투명도 0→1 전환 중 Surface의 검정 기본 배경이 1프레임 노출.
**해결**: `onboarding_form_page.dart`에서 `Scaffold` → `ColoredBox`로 교체

### C. 운명 분석 로딩 페이지 GIF 추가

**변경**: `destiny_analysis_page.dart` 로딩 화면에 `loading_spinner.gif`(160px) + "잠시만 기다려 주세요" 텍스트를 프로그레스 바 위에 배치
**레이아웃**: Spacer(flex:2) → GIF → 텍스트 → 60px gap → step indicator → phase text → progress bar → Spacer(flex:1)

### D. 로그인 페이지 리뉴얼

- 브랜드명 '사주인연' → **'momo'** 변경
- `glod_rabbit_thrash.gif` 캐릭터 GIF 추가 (카피 영역 아래, 버튼 위)
- GIF 프레임 보간: ffmpeg `minterpolate` 필터로 29프레임 → 87프레임 (부드러운 모션)
- GIF 속도 미세 조정: gifsicle로 프레임 딜레이 최적화 (20ms)

---

## 2026-02-27 완료된 작업 (1차)

### 0. 프로젝트 리네이밍: Saju App → **Momo**

> 상세 문서: `docs/dev-log/2026-02-27-rename-to-momo.md`

**앱 이름 확정**: momo
- 패키지명: `saju_app` → `momo_app`
- 루트 위젯: `SajuApp` → `MomoApp`
- iOS Bundle ID: `com.nworld.sajuApp` → `com.nworld.momo`
- Android App ID: `com.nworld.saju_app` → `com.nworld.momo`
- GitHub Repo: `unknownstarter/saju-app` → `unknownstarter/momo-app`
- 20+ 파일 일괄 수정, 빌드 검증 완료

### 0-1. Supabase 실연동 — 실제 사주/관상 분석 연결

- Supabase CLI 설치 (v2.75.0) + 프로젝트 링크 (`csjdfvxyjnpmbkjbomyf`)
- **DB 마이그레이션 5개 적용**: profiles, saju_profiles, gwansang_profiles 등 17개 테이블 + RLS 정책
- **Edge Functions 4개 배포**: calculate-saju, generate-saju-insight, generate-gwansang-reading, calculate-compatibility
- `ANTHROPIC_API_KEY` Supabase Secrets 등록
- Flutter `main.dart`에 실제 Supabase URL + Anon Key 적용
- `generate-saju-insight` Edge Function: `stem`/`branch` 형식 호환 추가
- Dart datasource: `sajuData` → `sajuResult` 키 이름 수정
- **실제 API 테스트 통과**: 1995-03-15 14:30 → 을해/기묘/을사/계미, AI 해석 + 관상 분석 모두 정상

### 1. 캐릭터 에셋 체계화 — 스프라이트 시트 → 개별 PNG 분리

**문제**: 캐릭터 에셋이 flat 파일(스프라이트 시트)로 관리되어 개별 표정/포즈 사용 불가
**해결**:
- 8개 캐릭터 × 4종(default, expressions, poses, views) 스프라이트 시트를 개별 PNG로 자동 분리
- Python scipy connected component analysis + rembg 배경 제거
- 총 103개 개별 파일 생성

**폴더 구조**:
```
assets/images/characters/{character}/
├── default.png
├── expressions/{emotion}.png
├── poses/{pose}.png
└── views/{direction}.png
```

### 2. CharacterAssets 코드 리팩토링

- `CharacterPath` 헬퍼 클래스 도입 → `CharacterAssets.namuri.expression('love')`
- 기존 `const` 상수 호환 유지 (16개 참조 파일 변경 불필요)
- pubspec.yaml 32개 에셋 디렉토리 등록

### 3. 나무리 default.png 누락 수정

- `namuri_wood_default.png` 파일이 아예 존재하지 않았음 (SVG만 있었음)
- SVG 변환 시 잘못된 캐릭터가 생성됨 → 원본 PNG로 교체

### 4. 나무리/나무리여친/쇠동이 누끼 재작업

- rembg(u2net) + "흰색 덮기" 방식으로 배경+텍스트 제거
- 연한 색 캐릭터는 rembg가 배경으로 인식할 수 있어 "캐릭터 외 영역을 흰색으로 덮고 → 누끼" 방식 사용

### 5. 빌드 검증

- `flutter analyze` 0 issues
- iOS simulator 빌드 성공

---

## 오늘 완료된 작업

### 1. 토스 스타일 미니멀 디자인 전면 리뉴얼 (`17e8198`)
- `SajuMatchCard` — 사진 오버레이 제거, 얇은 보더, radiusXl(20px) 적용
- `HomePage` — 타이포그래피 위계 중심 레이아웃, 넉넉한 여백(20-32px)
- `MatchingPage` — 깔끔한 헤더, 2열 그리드 간격 정리
- `CompatibilityPreviewPage` — 다크 모드 바텀시트, 신비로운 분위기

### 2. 캐릭터 에셋 경로 수정 + go_router 경로 불일치 해결 (`9864212`)
- **[CRITICAL]** `RoutePaths.matchDetail`: `/match/:matchId` → `/matching/:matchId` 경로 수정
- **[CRITICAL]** Mock 프로필 5개의 캐릭터 에셋 경로 전부 수정 (존재하지 않는 파일명 → 실제 파일명)
  - 예: `water_happy.png` → `mulgyeori_water_default.png`
- 홈/궁합 프리뷰 페이지의 캐릭터 에셋 경로 수정
- 캐릭터 배치 개선: 홈 인사 영역에 나무리(72px) 추가, 카드 캐릭터 56→72px

### 3. 클린 아키텍처 의존성 규칙 전면 정리 (`7c64928`)
- 아키텍처 감사 실시: 10개 의존성 규칙 위반 발견 (등급: C+, 60/100)
- **중앙 DI 레이어 신설**: `lib/core/di/providers.dart`
  - 모든 Repository/Datasource 인스턴스화를 이곳에서 관리
  - Presentation → Data 직접 참조 전면 차단
- `MatchProfile`을 data/models → domain/entities로 승격
- 4개 feature provider 파일에서 data layer import 제거
- cross-feature import 제거 (onboarding → profile/data)
- 리팩토링 후 등급: A- (85/100)
- 검증: flutter analyze 0 이슈, flutter test 67/67 pass

### 4. Phase 1 실궁합(calculate-compatibility) 연동 (2026-02-24)
- **Edge Function** `supabase/functions/calculate-compatibility/index.ts` 구현
  - 오행 상생상극 + 일주(천간합, 지지 육합/삼합/충/형/파/해) 기반 0~100 점수
  - fiveElementScore, dayPillarScore, strengths, challenges, overallAnalysis, advice
  - 스펙: `docs/plans/2026-02-24-phase1-calculate-compatibility-spec.md`
- **RLS**: `saju_select_recommended` 정책 추가 — 추천(daily_matches) 대상의 사주 조회 허용
- **Saju**: `getSajuForCompatibility(userId)` — DB saju_profiles 조회 후 궁합 요청용 payload 반환
- **Matching**: `MatchingRepositoryImpl` — 실궁합 Edge Function 호출, id/userId/partnerId·calculatedAt 클라이언트 주입
- **DI**: `matchingRepositoryProvider` → `MatchingRepositoryImpl` (Auth + Saju + SupabaseHelper)
- 추천/좋아요는 Phase 1에서 Mock 유지

### 5. 황금토끼/검은토끼 신규 캐릭터 추가 (`cb9c58a`)
- 8개 이미지 배경 제거 (누끼 처리): Python Pillow + scipy 사용
  - edge-connected flood fill 방식으로 배경만 정확히 제거
  - 검은토끼 외곽선 보존 (검정 몸체 vs 밝은 배경 구분)
- `검은토끼_표정.png`의 "기본", "우는" 한글 텍스트 라벨 제거
- 네이밍 컨벤션 적용: `gold_tokki_*.png`, `black_tokki_*.png`
- Mock 매칭 프로필 2명 추가:
  - 유진(25세) — 황금토끼, 금(金), 궁합 88점
  - 다은(26세) — 검은토끼, 수(水), 궁합 71점
- 궁합 강점/도전 데이터 추가

---

## 현재 프로젝트 상태

### 완료된 Phase
| Phase | 내용 | 상태 |
|-------|------|------|
| 1 | 프로젝트 설정 + Supabase 연동 | ✅ |
| 2 | 디자인 시스템 컴포넌트 | ✅ |
| 3 | Auth (소셜 로그인 + 온보딩) | ✅ |
| 4 | Profile (프로필 저장) | ✅ |
| 5 | Saju (사주 분석 + AI 해석) | ✅ |
| 6 | Matching + Home + 궁합 프리뷰 | ✅ |

### 아키텍처 현황
- **클린 아키텍처 등급**: A- (85/100)
- **의존성 위반**: 0건
- **테스트**: 67/67 pass
- **정적 분석**: 0 issues

### 캐릭터 에셋 현황 (2026-02-27 갱신)

**폴더 구조**: `assets/images/characters/{character}/{variant}/{name}.png` (총 103개)

| 캐릭터 | 폴더명 | 오행 | default | expressions/ | poses/ | views/ |
|--------|--------|------|---------|-------------|--------|--------|
| 나무리 | `namuri/` | 木/wood | ✅ | ✅ | ✅ | ✅ |
| 불꼬리 | `bulkkori/` | 火/fire | ✅ | ✅ | ✅ | ✅ |
| 흙순이 | `heuksuni/` | 土/earth | ✅ | ✅ | ✅ | ✅ |
| 쇠동이 | `soedongi/` | 金/metal | ✅ | ✅ | ✅ | ✅ |
| 물결이 | `mulgyeori/` | 水/water | ✅ | ✅ | ✅ | ✅ |
| 나무리GF | `namuri_gf/` | 木/wood | ✅ | ✅ | ✅ | ✅ |
| 황금토끼 | `gold_tokki/` | 金/metal | ✅ | ✅ | ✅ | ✅ |
| 검은토끼 | `black_tokki/` | 水/water | ✅ | ✅ | ✅ | ✅ |

**코드 접근**: `CharacterAssets.namuri.expression('love')` 또는 기존 `CharacterAssets.namuriWoodDefault`

---

## 2026-02-26 완료된 작업

### 6. 통합 사주+관상 온보딩 플로우 ("하나의 퍼널, 하나의 결과")

> 노아님 핵심 피드백: "사주와 관상 결과가 **함께** 나와야 한다. 자꾸 두 개로 분리하지 마라!"

**변경 전:** 온보딩 폼(5스텝) → 사주 분석 → 사주 결과 → (별도) 관상 브릿지 → 사진 → 관상 분석 → 관상 결과
**변경 후:** 온보딩 폼(6스텝: +사진) → 통합 분석(~10s: 사주→관상 순차) → 탭 결과([사주|관상]) → 매칭 프로필 → 홈

**수정 파일 (4개):**
- `onboarding_form_page.dart` — Step 4에 정면 사진 1장 스텝 추가 (5→6스텝)
- `onboarding_page.dart` — destinyAnalysis로 라우팅 변경
- `app_constants.dart` — destinyAnalysis/destinyResult 경로 상수
- `app_router.dart` — destiny 라우트 2개 + publicPaths 등록

**신규 파일 (2개):**
- `lib/features/destiny/presentation/pages/destiny_analysis_page.dart` (~630줄)
  - 5-phase 10초 애니메이션 연출 (5캐릭터 원형 회전 + 글로우)
  - 사주 분석 → 완료 후 관상 분석 순차 실행 (기술 제약: 관상이 사주 데이터에 의존)
  - 관상 실패 시 graceful degradation (사주만으로 결과 진행)
- `lib/features/destiny/presentation/pages/destiny_result_page.dart` (~916줄)
  - NestedScrollView + SliverPersistentHeader로 TabBar [사주|관상] 고정
  - 공통 히어로 헤더: 오행 캐릭터(96px) + 동물상 이모지(52px) 겹침
  - 사주 탭: 4기둥 카드, 오행 차트, 성격 칩, AI 해석
  - 관상 탭: 동물상 히어로, 매력 키워드, 성격/연애, 사주시너지, 잘 맞는 동물상
  - 하단 CTA: "운명의 인연 찾으러 가기" → matchingProfile quickMode

**기존 분리 퍼널은 유지** — 홈 넛지에서 관상 브릿지/사진/분석/결과 접근 가능

---

## 다음 액션 아이템 (Next Steps)

**→ 상세·우선순위·담당은 테스크 마스터를 보세요:** `docs/plans/2026-02-24-task-master.md`

- **즉시**: daily_matches 실데이터, 궁합 프리뷰 실사용 검증
- **단기**: 궁합 규칙집·상세 리포트, 십신 보강, 받은 좋아요/프로필 편집 페이지
- **중기**: Phase 7 Chat, Phase 8 Payment, Supabase 실연동
- **장기**: 궁합 가중치 A/B, 푸시 알림, 바이럴·분석

---

## 아키텍처·디자인 리뷰 권장사항 이행 (2026-02-24)

근거: `docs/review/2026-02-24-architecture-design-review.md`  
플랜: `docs/plans/2026-02-24-review-action-plan.md` (테스크 마스터)  
PRD 반영: `docs/plans/2026-02-24-app-design.md` §4.6에 플랜 링크 추가

### 완료한 작업
1. **프로필 탭 "내 캐릭터"** — ProfilePage 헤더에 나무리 72px 배치 (오행 배정 전 기본값)
2. **SajuEmptyState / SajuErrorState** — `lib/core/widgets/` 공통 위젯 추가, `widgets.dart` export
3. **채팅 빈/에러** — ChatListPage: 빈 상태 → 물결이 + SajuEmptyState, 에러 → 나무리 + SajuErrorState
4. **매칭 빈/에러** — MatchingPage: 빈 그리드 → 흙순이 + SajuEmptyState, 에러 → SajuErrorState
5. **프로필 에러** — ProfilePage error → SajuErrorState (다시 시도)
6. **여백 토큰** — ProfilePage/MatchingPage 일부 SizedBox·padding을 AppTheme.spacingXl/spacingSm 등으로 통일

### 산출물
- `lib/core/widgets/saju_empty_state.dart` — 캐릭터 + message + subtitle + 선택 CTA
- `lib/core/widgets/saju_error_state.dart` — 캐릭터 + message + 다시 시도
- 테스크 마스터 7개 항목 완료 체크, 리뷰 문서 액션 아이템에 "완료" 상태 반영

---

## 오늘의 교훈 (Lessons Learned)

### 1. go_router 경로 상수는 반드시 실제 라우트 구조와 일치시킬 것
- `RoutePaths.matchDetail`이 `/match/:matchId`였으나 실제 GoRoute는 `/matching/:matchId`로 해석
- **규칙**: 라우트 추가/변경 시 `app_constants.dart`의 RoutePaths와 `app_router.dart`의 GoRoute를 동시에 검증할 것

### 2. 캐릭터 에셋 경로는 실제 파일명과 1:1 매핑을 검증할 것
- Mock 데이터에서 `water_happy.png` 같은 존재하지 않는 파일을 참조하고 있었음
- **규칙**: 에셋 경로를 하드코딩할 때 반드시 `assets/images/characters/` 디렉토리의 실제 파일 목록과 대조

### 3. 클린 아키텍처 의존성은 중앙 DI로 관리
- Presentation → Data 직접 참조가 자연스럽게 쌓이는 문제
- **해결책**: `lib/core/di/providers.dart`에서 모든 Repository/Datasource를 인스턴스화
- **규칙**: 새 feature 추가 시 반드시 core/di/providers.dart에 DI Provider 등록

### 4. "미니멀"과 "휑한 것"은 다르다
- 토스 스타일 미니멀 적용 시 캐릭터를 모두 제거하면 개성이 사라짐
- **규칙**: 장식은 줄이되, 캐릭터는 적절한 크기(64-72px)로 핵심 위치에 배치

### 5. 이미지 누끼 처리 시 색상 분석 선행
- 검은토끼의 검정 몸체가 배경과 혼동될 수 있었음
- **해결책**: 히스토그램 분석으로 배경(RGB 230+)과 캐릭터(RGB 0-51) 색상 분포 확인 후 threshold 설정
- edge-connected flood fill로 배경에 연결된 밝은 영역만 제거 (캐릭터 내부의 밝은 부분 보존)

### 6. 다른 디바이스에서 연속 작업하려면 테스크 마스터·문서를 먼저 볼 것
- **규칙**: 이어서 작업할 때는 `docs/plans/2026-02-24-task-master.md`(테스크 마스터)를 열어 다음 할 일·우선순위·참조 문서를 확인할 것.
- **PRD**: `docs/plans/2026-02-24-app-design.md` §12에 백로그 요약과 테스크 마스터 링크 있음.
- **개발자룰**: `CLAUDE.md`에 "연속 작업 / 다음 할 일" 섹션에서 위 문서 위치를 안내함.
- 작업 완료 시 테스크 마스터에서 해당 Task 상태를 ✅로 갱신하고, 필요하면 dev-log에 한 줄 반영.

### 7. 테마 타입 혼동 주의 — SajuColors (NOT SajuColorScheme)
- 프로젝트의 테마 확장 타입은 `SajuColors`이지 `SajuColorScheme`이 아님
- **파일**: `lib/core/theme/tokens/saju_colors.dart`
- 새 페이지에서 `Theme.of(context).extension<SajuColors>()` 패턴 사용

### 8. 순차 분석 패턴 — 의존성 있는 API 호출
- 관상 분석은 사주 데이터(dominant_element, day_stem, personality_traits)에 의존
- 사주 분석 완료 → 결과에서 sajuData 추출 → 관상 분석 시작
- graceful degradation: 관상 실패 시 사주 결과만으로 진행 가능하도록 null 처리

### 9. git worktree 정리 순서
- 브랜치 삭제 전에 **반드시 worktree를 먼저 제거**할 것
- 순서: `git worktree remove <path>` → `git branch -d <branch>`
- 역순이면 "branch is checked out" 에러 발생

### 10. FadeTransition + Scaffold = 검은 프레임 (2026-02-27)
- `FadeTransition`은 `saveLayer`를 사용하므로, 내부에 `Scaffold`(별도 Surface)를 넣으면 투명도 전환 중 검정 배경이 노출됨
- **해결**: `Scaffold` 대신 `ColoredBox`로 교체하면 Surface 레이어 없이 직접 배경색을 칠함

### 11. Flutter Column에서 Spacer flex 경쟁 (2026-02-27)
- `Spacer(flex:N)` 사이에 고정 크기 위젯(`SizedBox`, `Image`)을 넣어도 flex가 남은 공간을 전부 차지하여 고정 위젯이 0으로 눌릴 수 있음
- **해결**: 고정 위젯을 `Expanded`로 감싸거나, Spacer 배치를 양끝에만 두어 경쟁을 최소화

### 12. GIF 뚝뚝 끊김 → 프레임 보간으로 해결 (2026-02-27)
- 프레임 수가 부족한 GIF(29프레임)는 딜레이를 늘려도 모션 갭으로 끊겨 보임
- **해결**: ffmpeg `minterpolate=fps=30:mi_mode=blend` 필터로 중간 프레임을 AI 블렌딩 생성 (29→87프레임)
- 팔레트 최적화: `palettegen + paletteuse + floyd_steinberg` 디더링으로 GIF 품질 유지

### 13. static final vs const 컨텍스트 (2026-02-27)
- `static final`은 `const` 컨텍스트에서 사용 불가
- `CharacterPath.defaultImage`(getter)는 const가 아님 → 기존 const 호환 위해 `static const` 문자열 병행 유지
- 기존 코드에서 `const` 위젯 안에 에셋 경로를 쓰는 곳이 있으면, 해당 경로는 반드시 `static const String`이어야 함

### 11. Flutter 에셋 캐시 — hot reload 불반영 (2026-02-27)
- 에셋 추가/변경 후에는 `flutter clean` + full rebuild 필수
- hot reload / hot restart로는 새 에셋이 반영되지 않음
- 시뮬레이터에서 "이미지 안 뜸" 이슈 시 가장 먼저 `flutter clean` 시도

### 12. 스프라이트 시트 분리 기법 (2026-02-27)
- connected component analysis가 연한 색 캐릭터를 병합할 수 있음 → column-based splitting으로 우회
- 누끼 작업: 연한 색 캐릭터는 rembg가 배경으로 인식 → "캐릭터 외 영역을 흰색으로 덮고 → rembg" 방식이 효과적
- SVG→PNG 변환 시 원본 디자인과 반드시 대조 검증 필요
