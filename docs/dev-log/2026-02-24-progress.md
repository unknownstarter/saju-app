# 개발 일지 — 2026-02-24

## 오늘 완료된 작업

### 1. 토스 스타일 미니멀 디자인 전면 리뉴얼 (`17e8198`)
- `SajuMatchCard` — 사진 오버레이 제거, 얇은 보더, radiusXl(20px) 적용
- `HomePage` — 타이포그래피 위계 중심 레이아웃, 넉넉한 여백(20-32px)
- `MatchingPage` — 깔끔한 헤더, 2열 그리드 간격 정리
- `CompatibilityPreviewPage` — 다크 모드 바텀시트, 신비로운 분위기

### 2. 캐릭터 에셋 경로 수정 + go_router 경로 불일치 해결 (`9864212`)
- **[CRITICAL]** `RoutePaths.matchDetail`: `/match/:matchId` → `/matching/:matchId` 경로 수정
- **[CRITICAL]** Mock 프로필 5개의 캐릭터 에셋 경로 전부 수정 (존재하지 않는 파일명 → 실제 파일명)
  - 예: `water_happy.png` → `mulgyeori_water_default.png`
- 홈/궁합 프리뷰 페이지의 캐릭터 에셋 경로 수정
- 캐릭터 배치 개선: 홈 인사 영역에 나무리(72px) 추가, 카드 캐릭터 56→72px

### 3. 클린 아키텍처 의존성 규칙 전면 정리 (`7c64928`)
- 아키텍처 감사 실시: 10개 의존성 규칙 위반 발견 (등급: C+, 60/100)
- **중앙 DI 레이어 신설**: `lib/core/di/providers.dart`
  - 모든 Repository/Datasource 인스턴스화를 이곳에서 관리
  - Presentation → Data 직접 참조 전면 차단
- `MatchProfile`을 data/models → domain/entities로 승격
- 4개 feature provider 파일에서 data layer import 제거
- cross-feature import 제거 (onboarding → profile/data)
- 리팩토링 후 등급: A- (85/100)
- 검증: flutter analyze 0 이슈, flutter test 67/67 pass

### 4. Phase 1 실궁합(calculate-compatibility) 연동 (2026-02-24)
- **Edge Function** `supabase/functions/calculate-compatibility/index.ts` 구현
  - 오행 상생상극 + 일주(천간합, 지지 육합/삼합/충/형/파/해) 기반 0~100 점수
  - fiveElementScore, dayPillarScore, strengths, challenges, overallAnalysis, advice
  - 스펙: `docs/plans/2026-02-24-phase1-calculate-compatibility-spec.md`
- **RLS**: `saju_select_recommended` 정책 추가 — 추천(daily_matches) 대상의 사주 조회 허용
- **Saju**: `getSajuForCompatibility(userId)` — DB saju_profiles 조회 후 궁합 요청용 payload 반환
- **Matching**: `MatchingRepositoryImpl` — 실궁합 Edge Function 호출, id/userId/partnerId·calculatedAt 클라이언트 주입
- **DI**: `matchingRepositoryProvider` → `MatchingRepositoryImpl` (Auth + Saju + SupabaseHelper)
- 추천/좋아요는 Phase 1에서 Mock 유지

### 5. 황금토끼/검은토끼 신규 캐릭터 추가 (`cb9c58a`)
- 8개 이미지 배경 제거 (누끼 처리): Python Pillow + scipy 사용
  - edge-connected flood fill 방식으로 배경만 정확히 제거
  - 검은토끼 외곽선 보존 (검정 몸체 vs 밝은 배경 구분)
- `검은토끼_표정.png`의 "기본", "우는" 한글 텍스트 라벨 제거
- 네이밍 컨벤션 적용: `gold_tokki_*.png`, `black_tokki_*.png`
- Mock 매칭 프로필 2명 추가:
  - 유진(25세) — 황금토끼, 금(金), 궁합 88점
  - 다은(26세) — 검은토끼, 수(水), 궁합 71점
- 궁합 강점/도전 데이터 추가

---

## 현재 프로젝트 상태

### 완료된 Phase
| Phase | 내용 | 상태 |
|-------|------|------|
| 1 | 프로젝트 설정 + Supabase 연동 | ✅ |
| 2 | 디자인 시스템 컴포넌트 | ✅ |
| 3 | Auth (소셜 로그인 + 온보딩) | ✅ |
| 4 | Profile (프로필 저장) | ✅ |
| 5 | Saju (사주 분석 + AI 해석) | ✅ |
| 6 | Matching + Home + 궁합 프리뷰 | ✅ |

### 아키텍처 현황
- **클린 아키텍처 등급**: A- (85/100)
- **의존성 위반**: 0건
- **테스트**: 67/67 pass
- **정적 분석**: 0 issues

### 캐릭터 에셋 현황 (assets/images/characters/)
| 캐릭터 | 한국명 | 오행 | default | expressions | poses | turnaround |
|--------|--------|------|---------|-------------|-------|------------|
| 나무리 | 나무리 | 木/wood | ✅ | ✅ | ✅ | ✅ |
| 불꼬리 | 불꼬리 | 火/fire | ✅ | ✅ | ✅ | ✅ |
| 흙순이 | 흙순이 | 土/earth | ✅ | ✅ | ✅ | ✅ |
| 쇠동이 | 쇠동이 | 金/metal | ✅ | ✅ | ✅ | ✅ |
| 물결이 | 물결이 | 水/water | ✅ | ✅ | ✅ | ✅ |
| 나무리GF | 나무리 여친 | 木/wood | ✅ | ✅ | ✅ | ✅ |
| 황금토끼 | 황금토끼 | 金/metal | ✅ | ✅ | ✅ | ✅ |
| 검은토끼 | 검은토끼 | 水/water | ✅ | ✅ | ✅ | ✅ |

---

## 다음 액션 아이템 (Next Steps)

**→ 상세·우선순위·담당은 테스크 마스터를 보세요:** `docs/plans/2026-02-24-task-master.md`

- **즉시**: daily_matches 실데이터, 프로필·사주 저장 연동, 궁합 프리뷰 실사용 검증
- **단기**: 궁합 규칙집·상세 리포트, 십신 보강, 받은 좋아요/프로필 편집 페이지
- **중기**: Phase 7 Chat, Phase 8 Payment, Supabase 실연동
- **장기**: 궁합 가중치 A/B, 푸시 알림, 바이럴·분석

---

## 아키텍처·디자인 리뷰 권장사항 이행 (2026-02-24)

근거: `docs/review/2026-02-24-architecture-design-review.md`  
플랜: `docs/plans/2026-02-24-review-action-plan.md` (테스크 마스터)  
PRD 반영: `docs/plans/2026-02-24-app-design.md` §4.6에 플랜 링크 추가

### 완료한 작업
1. **프로필 탭 "내 캐릭터"** — ProfilePage 헤더에 나무리 72px 배치 (오행 배정 전 기본값)
2. **SajuEmptyState / SajuErrorState** — `lib/core/widgets/` 공통 위젯 추가, `widgets.dart` export
3. **채팅 빈/에러** — ChatListPage: 빈 상태 → 물결이 + SajuEmptyState, 에러 → 나무리 + SajuErrorState
4. **매칭 빈/에러** — MatchingPage: 빈 그리드 → 흙순이 + SajuEmptyState, 에러 → SajuErrorState
5. **프로필 에러** — ProfilePage error → SajuErrorState (다시 시도)
6. **여백 토큰** — ProfilePage/MatchingPage 일부 SizedBox·padding을 AppTheme.spacingXl/spacingSm 등으로 통일

### 산출물
- `lib/core/widgets/saju_empty_state.dart` — 캐릭터 + message + subtitle + 선택 CTA
- `lib/core/widgets/saju_error_state.dart` — 캐릭터 + message + 다시 시도
- 테스크 마스터 7개 항목 완료 체크, 리뷰 문서 액션 아이템에 "완료" 상태 반영

---

## 오늘의 교훈 (Lessons Learned)

### 1. go_router 경로 상수는 반드시 실제 라우트 구조와 일치시킬 것
- `RoutePaths.matchDetail`이 `/match/:matchId`였으나 실제 GoRoute는 `/matching/:matchId`로 해석
- **규칙**: 라우트 추가/변경 시 `app_constants.dart`의 RoutePaths와 `app_router.dart`의 GoRoute를 동시에 검증할 것

### 2. 캐릭터 에셋 경로는 실제 파일명과 1:1 매핑을 검증할 것
- Mock 데이터에서 `water_happy.png` 같은 존재하지 않는 파일을 참조하고 있었음
- **규칙**: 에셋 경로를 하드코딩할 때 반드시 `assets/images/characters/` 디렉토리의 실제 파일 목록과 대조

### 3. 클린 아키텍처 의존성은 중앙 DI로 관리
- Presentation → Data 직접 참조가 자연스럽게 쌓이는 문제
- **해결책**: `lib/core/di/providers.dart`에서 모든 Repository/Datasource를 인스턴스화
- **규칙**: 새 feature 추가 시 반드시 core/di/providers.dart에 DI Provider 등록

### 4. "미니멀"과 "휑한 것"은 다르다
- 토스 스타일 미니멀 적용 시 캐릭터를 모두 제거하면 개성이 사라짐
- **규칙**: 장식은 줄이되, 캐릭터는 적절한 크기(64-72px)로 핵심 위치에 배치

### 5. 이미지 누끼 처리 시 색상 분석 선행
- 검은토끼의 검정 몸체가 배경과 혼동될 수 있었음
- **해결책**: 히스토그램 분석으로 배경(RGB 230+)과 캐릭터(RGB 0-51) 색상 분포 확인 후 threshold 설정
- edge-connected flood fill로 배경에 연결된 밝은 영역만 제거 (캐릭터 내부의 밝은 부분 보존)

### 6. 다른 디바이스에서 연속 작업하려면 테스크 마스터·문서를 먼저 볼 것
- **규칙**: 이어서 작업할 때는 `docs/plans/2026-02-24-task-master.md`(테스크 마스터)를 열어 다음 할 일·우선순위·참조 문서를 확인할 것.
- **PRD**: `docs/plans/2026-02-24-app-design.md` §12에 백로그 요약과 테스크 마스터 링크 있음.
- **개발자룰**: `CLAUDE.md`에 "연속 작업 / 다음 할 일" 섹션에서 위 문서 위치를 안내함.
- 작업 완료 시 테스크 마스터에서 해당 Task 상태를 ✅로 갱신하고, 필요하면 dev-log에 한 줄 반영.
