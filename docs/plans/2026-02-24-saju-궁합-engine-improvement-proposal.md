# 사주·궁합 엔진 개선 제안서

> **역할**: Product Manager (PM)  
> **작성일**: 2026-02-24  
> **목적**: 개인 사주 → 궁합 → 매칭 핵심 가치 실현을 위해, 사주/궁합 엔진의 진화 필요성 판단 및 구체적 개선 옵션·로드맵 제안

---

## 1. 현재 상태 (코드베이스 기준)

### 1.1 사주 계산

| 항목 | 내용 |
|------|------|
| **구현 위치** | `supabase/functions/calculate-saju/index.ts` |
| **라이브러리** | `@fullstackfamily/manseryeok@1.0.7` (한국천문연구원 KASI 데이터 기반 만세력) |
| **입력** | `birthDate`(YYYY-MM-DD), `birthTime`(HH:mm, optional), `isLunar`, `isLeapMonth` |
| **산출물** | 연·월·일·시주(천간/지지), 오행 분포(목·화·토·금·수 개수), 주도 오행(일간 기준) |
| **특징** | 음력→양력 변환, 절기·진태양시 보정 포함. 시주 미입력 시 삼주만 반환. |

- **한자(hanja)**: Edge Function 응답에는 한자 미포함. 클라이언트는 `app_constants.dart`의 `HeavenlyStems.hanja`, `EarthlyBranches.hanja`로 표기.
- **도메인**: `lib/features/saju/` — `SajuProfile`, `Pillar`, `FiveElements`, `FiveElementType` 등. `core/domain/entities/compatibility_entity.dart`에 궁합 엔티티(점수, 강점/도전, 등급) 정의.

### 1.2 궁합(Compatibility) 사용처

- **매칭 추천**: `MatchProfile.compatibilityScore` (0~100). 정렬·필터·카드 표시에 사용.
- **궁합 프리뷰**: `Compatibility` — `score`, `fiveElementScore`, `dayPillarScore`, `overallAnalysis`, `strengths`, `challenges`, `advice`, `aiStory`.
- **채팅/매칭**: 채팅방·매칭 엔티티에 `compatibilityScore` 필드로 보존.

**현재 궁합 계산 구현 상태**: **미구현**.  
- `SupabaseFunctions.calculateCompatibility` 상수와 설계 문서(`app-design.md`, `phase6-matching-home.md`)에 `calculate-compatibility` Edge Function이 정의되어 있으나, **실제 함수는 없음**.  
- 매칭은 **Mock만 존재**: `MatchingRepositoryImpl`(및 MockMatchingRepository)이 하드코딩된 프로필 리스트와 고정 궁합 점수·강점/도전 문구를 반환. `fiveElementScore`/`dayPillarScore`는 mock score에서 0.9x, 1.1x로 파생.

### 1.3 매칭 플로우 (설계 기준)

- **추천 리스트**: 설계상 `get-daily-matches` cron으로 궁합 기반 추천 생성 예정. 현재는 Mock 리스트.
- **궁합 소비**: 매칭 카드 터치 시 `getCompatibilityPreview(partnerId)` → 상세는 유료(500P).
- **선호도**: 설계에는 사주+선호(나이, 거리 등) 혼합 추천이 있으나, 현재 코드에는 선호도 기반 로직 없음.

### 1.4 정리

- **사주 엔진**: 4기둥·오행·주도오행까지는 **실서비스 가능 수준**. KASI 기반 만세력으로 신뢰도 확보.
- **궁합 엔진**: **실제 계산 로직 없음**. 도메인·UI는 궁합 점수/세부 항목(fiveElementScore, dayPillarScore)을 전제하나, 서버/Edge Function 구현이 없어 **반드시 구현 필요**.
- **매칭**: 궁합 기반 랭킹·추천은 궁합 계산 구현 이후 연동 필요.

---

## 2. 시장·사용자 리서치

### 2.1 한국 사용자가 연애/결혼 맥락에서 기대하는 “사주 궁합”

- **오행 상생/상극**: 기본 기대치. “상생=좋음, 상극=나쁨”이 아니라, 상극도 “적절한 극”이면 보완·긴장으로 해석하는 수요 존재.
- **일주(일간·일지)**: 배우자궁·본인궁으로 인식되며, **궁합의 50% 이상 비중**을 두는 전문 해석과 사용자 기대가 맞음.
- **합·충·형·파·해**: 천간합/지지 육합·삼합·충·형·해 등 “글자끼리 관계”를 궁합 점수·이야기로 기대.
- **십신(十神)**: “상대가 나에게 어떤 역할(편재, 정관 등)인가”에 대한 니즈 있음. 데이팅 앱에서는 단순화된 십신 스토리텔링으로 충족 가능.
- **대운·세운**: 결혼·연애 타이밍, “지금 만나도 되는 시기인가”에 대한 관심 있으나, 우선순위는 4기둥·오행·일주 궁합보다 낮음.
- **요약**: “점수 + 이유(오행/일주/이야기)” 조합을 원함. 단순 점수만으로는 신뢰·재방문이 떨어질 수 있음.

### 2.2 기존 제품 (사주 + 궁합 + 매칭)

| 제품 | 제공 내용 | 부족한 점 |
|------|-----------|-----------|
| **궁합팅** (스타지오소프트) | 사주 기반 0~100 궁합점수, 90점 이상 1명/일 무료 매칭, AI 100만 쌍 분석 | 구체적 알고리즘·오행/일주 해석 노출 정도 불명. 차별화 포인트는 “오행이 캐릭터” 등 스토리텔링. |
| **미리 소개팅** | 사주 입력 → 궁합 좋은 추천, MBTI 궁합, Q&A이구동성, 관상/운세 테스트 | 사주 궁합의 세부 항목(오행/일주/십신) 노출이 얼마나 되는지 불명. MZ 맞춤 콘텐츠 강점. |

- **공통**: “사주 궁합 점수 + 매칭” 구조. **차별화**는 (1) 궁합 해석의 투명성(오행/일주/십신 등), (2) 스토리·캐릭터 연출, (3) UX(무료 횟수, 프리미엄 가치)에서 나올 수 있음.

### 2.3 B2B·API

- **운세위키(LuckyloveMe)**: 건당 과금, 십성·12운성·신강신약·격국·용신·합충형파해·신살·대운·세운 등 제공. 궁합 전용 API 여부는 확인 필요.
- **Ablecity**: 만세력 v2.0, 합화·탐합망충·3D 가중치 등. 엔터프라이즈; 비용·연동 방식 검토 필요.
- **정리**: 상용 API로 “고급 궁합(십신·용신·대운)”을 보강하는 선택지 존재. 자체 4기둥+오행+일주 궁합을 먼저 구현한 뒤, 필요 시 API로 확장하는 전략이 현실적.

---

## 3. 기술·도메인 리서치

### 3.1 전문 명리에서 궁합에 쓰는 요소 (4기둥 외)

- **일주(일간·일지)**: 일주 합(천간합·지지 육합/삼합), 충·형·파·해 — **데이팅 앱에서 필수**.
- **십신**: 상대 일간이 나의 일간에 대해 어떤 십신인지(편재·정관 등) → 역할·관계 스토리. 구현 시 “십신 매트릭스” 규칙집 필요.
- **용신/희신**: 개인 사주 강약·용신 판단 후 “상대 오행이 내 용신을 돕는가”까지 가면 고급. 1차 개선에서는 생략 가능.
- **대운·세운**: 10년·연 단위 운. 결혼/연애 타이밍에 유용하나, 매칭 점수보다는 “상세 궁합 리포트”나 유료 해석에서 다루는 것이 적합.
- **신살**: 도화살·천을귀인 등은 스토리용으로만 긍정적 표현 선별 사용 가능(fortune-master 스킬 정책과 일치).

### 3.2 고도화 궁합/매칭에 필요한 데이터·알고리즘

- **데이터**:  
  - 만세력: 현재 KASI 기반 manseryeok으로 충분.  
  - 천간합/지지 육합·삼합·충·형·파·해: 규칙 테이블(상수 또는 설정). `app_constants.dart`의 `FiveElementRelations`와 fortune-master 스킬의 규칙을 Edge Function으로 이식 가능.  
  - 십신: 일간 간 관계 → 십신 매핑 테이블. 학계/업계 공개 자료 또는 전문가 검수 규칙집.
- **알고리즘**:  
  - fortune-master 스킬의 100점 배점 구조(일주 30점, 오행 보완 15점, 십신 15점, 년/월/시 25점, 종합 15점, 감점)를 그대로 또는 단순화해 채택 가능.  
  - A/B 테스트를 위해 **가중치를 설정/DB로 분리**해 두는 것이 좋음.

### 3.3 현재 스택 적합성

- **Supabase Edge Functions + npm(manseryeok)**:  
  - 4기둥·오행 계산은 **현 구조로 충분**.  
  - 궁합 계산(오행+일주+선택적 십신)도 Edge Function 내 순수 로직으로 구현 가능.  
- **전용 서비스/다른 데이터소스**:  
  - 십신·용신·대운·세운까지 포함한 “고급 궁합”을 빠르게 쓰고 싶다면 **외부 API(운세위키 등)** 연동이 유리.  
  - 장기적으로는 자체 규칙 + 전문가 검수로 신뢰도·차별화를 노릴 수 있음.

**결론**:  
- **Phase 1**: Edge Function만으로 **오행 상생상극 + 일주 합·충·형·해** 기반 궁합 점수 및 brief 텍스트 구현 가능.  
- **Phase 2**: 십신 규칙 추가 시, 자체 테이블 구현 또는 외부 API 검토.

---

## 4. 역할별 협업 관점

### 4.1 Backend / Data

- **확장성**: 궁합 계산은 “두 프로필 입력 → 한 번 계산”이므로, cron으로 일괄 추천 생성 시 호출 수가 커질 수 있음. 배치 크기·캐싱(동일 쌍 재계산 방지)·Rate limit 검토.
- **개인화**: 선호(나이·거리·관심사)와 궁합 점수를 어떻게 섞을지(가중 평균, 필터 후 궁합 정렬 등) 정책 결정 필요.
- **A/B 테스트**: 궁합 가중치(오행 vs 일주 vs 십신 비율)를 파라미터화해 실험. Backend/Data가 실험 플래그·가중치 저장소 설계.

### 4.2 도메인 전문가 (명리/사주)

- **허용 가능한 단순화**:  
  - 오행만으로 0~100 점수 부여, 일주 합·충만 반영, “상극=무조건 감점”이 아닌 “과도한 극만 감점” 등 — **데이팅용으로는 수용 가능**한 수준으로 정리 필요.
- **신뢰도 해치기 쉬운 부분**:  
  - 일주를 무시하고 오행만으로만 궁합을 말하는 것, 충·형을 과대 해석해 “절대 안 맞는다”로 단정하는 것.  
- **권장**: 최소 “오행 + 일주(천간합·지지 육합/충)”는 반드시 포함. 십신은 2단계에서 전문가 검수 규칙으로 추가.

### 4.3 Growth / UX

- **노출 방식**:  
  - **점수**: 0~100 또는 등급(천생연분/좋은 인연 등) — 한 눈에 보이게.  
  - **이유**: “오행 상생”, “일주가 잘 맞아요” 등 2~3줄 문장 + 강점/도전 3개 안내.  
  - **스토리**: 상세 궁합은 유료(500P)로 “AI 궁합 스토리” 제공 — 과부하 방지.  
- **오버웨임 방지**: 첫 화면에는 점수+등급+한두 문장만, “더 보기”로 강점/도전/조언 펼치기.

---

## 5. 개선 제안 요약

### 5.1 “사주 엔진이 진화해야 하는가?”

- **사주 계산 엔진**: 현재만으로도 **진화 필수는 아님**. KASI 기반 4기둥·오행은 유지.  
  - 선택 개선: 진태양시 보정(출생지 경도), 한자 응답 포함 등은 우선순위 낮음.
- **궁합 엔진**: **반드시 진화(실질적으로는 신규 구현)** 필요.  
  - 이유: 핵심 가치가 “개인 사주 → 궁합 → 매칭”인데, 궁합이 Mock이라 서비스 신뢰도·차별화가 불가능함.

### 5.2 구체적 개선 옵션 (2~4개)

| # | 옵션 | 요약 | 근거 | 공수 | 영향 | 담당 |
|---|------|------|------|------|------|------|
| 1 | **실궁합 계산 Edge Function 도입** | `calculate-compatibility` 구현. 오행 상생상극 + 일주(천간합, 지지 육합/삼합/충/형/해) 기반 0~100 점수 + fiveElementScore/dayPillarScore + strengths/challenges 문구 생성. | 현재 궁합이 전부 Mock이라 실제 서비스 불가. 도메인·UI는 이미 이 스키마를 전제함. | **L** | 차별화·신뢰·이탈 방지에 직결. | Backend + 명리 검수 |
| 2 | **십신 기반 커플 궁합 보강** | 일간 대 일간 십신 관계 테이블 도입 → “상대가 나에게 OO(편재·정관 등) 역할” 스토리 + 점수 15점분 반영. | 사용자 기대(“우리 관계가 어떤 역할인가”)와 전문 해석(십신)을 연결. | **M** | 스토리·신뢰도 상승. | Backend + 도메인 전문가 |
| 3 | **궁합 가중치 A/B 테스트 인프라** | 궁합 점수 식의 가중치(오행/일주/십신 비율)를 DB 또는 Feature Flag로 관리하고, 코호트별로 다른 가중치 적용해 매칭 만족도·유료 전환 지표 측정. | 최적 가중치를 데이터로 찾기 위함. | **M** | 장기 retention·수익화. | Backend + Data |
| 4 | **전문가 검수 궁합 규칙집 + 상세 리포트** | 명리 전문가와 함께 “데이팅용 궁합 규칙” 문서화(합충형파해, 감점 상한, 표현 가이드). 상세 궁합(500P)에서 이 규칙 기반 해석 + AI 스토리 결합. | “그냥 AI가 만든 것”이 아니라 규칙 기반이라 신뢰도 확보. | **S~M** | 브랜드·프리미엄 가치. | PM + 도메인 전문가 + Backend |

### 5.3 우선순위 로드맵

- **Phase 1 (필수)**  
  - **실궁합 계산 Edge Function (옵션 1)**  
  - `calculate-compatibility` 구현: 두 `saju_profiles`(또는 동등 입력)를 받아 오행+일주 기반 점수, fiveElementScore/dayPillarScore, strengths/challenges 반환.  
  - Matching 쪽: Mock 대신 이 Edge Function 호출하도록 Repository/DataSource 교체.  
  - **이유**: 궁합이 없으면 “사주 궁합 매칭”이라는 핵심 가치가 성립하지 않음.

- **Phase 2 (차별화·신뢰)**  
  - **옵션 4 (규칙집 + 상세 리포트)**  
  - 전문가와 데이팅용 궁합 규칙·표현 가이드 정리 후, 상세 궁합 리포트에 반영.  
  - **옵션 2 (십신 보강)**  
  - 일주 중심에 더해 십신 관계 점수·문구 추가.  
  - **이유**: “왜 이 점수인가”를 설명할 수 있어야 재방문·유료 전환이 늘어남.

- **Phase 3 (데이터 드리븐)**  
  - **옵션 3 (궁합 가중치 A/B)**  
  - 가중치를 변경 가능하게 두고, 매칭 만족도·이탈률·유료 전환 지표로 실험.  
  - **이유**: 초기 가중치는 휴리스틱이므로, 실사용 데이터로 튜닝하는 단계가 필요함.

---

## 6. 다음 액션 (실행 주체 참고)

- **PM**: Phase 1 범위 확정(오행+일주 항목 목록, 점수 구간, 문구 톤 가이드) 및 Phase 2 규칙집 기획.
- **Backend**: `calculate-compatibility` Edge Function 스펙 작성(입출력 JSON, 에러 코드), fortune-master 스킬의 배점 구조 이식, Mock 제거 후 연동.
- **도메인 전문가**: 일주 합·충·형·해 규칙표 검수, 데이팅용 해석 표현 가이드, (Phase 2) 십신 매트릭스 초안.
- **Data**: 궁합 호출 로그·캐싱 정책, (Phase 3) A/B 실험용 가중치 스키마 설계.

---

*이 문서는 코드베이스(`lib/features/saju`, `lib/features/matching`, `supabase/functions`, `docs/`), 시장·기술 리서치, 역할별 관점을 바탕으로 작성되었으며, 다른 에이전트 또는 인력이 이 계획을 실행할 수 있도록 구체적으로 기술하였다.*
